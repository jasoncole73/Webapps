<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auto Loan Calculator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
    <style>
        /* --- CSS Variables --- */
        :root {
            --primary-green: #2e8b57; /* Sea Green */
            --secondary-green: #3cb371; /* Medium Sea Green */
            --light-green: #8fbc8f; /* Dark Sea Green */
            --very-light-green: #f0fff0; /* Honeydew */
            --dark-green: #006400; /* Dark Green */
            --input-bg: #ffffff;
            --input-border: #cccccc;
            --text-dark: #333333;
            --text-light: #ffffff;
            --error-red: #dc3545; /* Red for errors */
            --button-secondary-bg: #6c757d; /* Gray for secondary buttons */
            --button-secondary-hover: #5a6268;
            --table-border-color: #dee2e6;
        }
        
        /* --- Global Styles --- */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f8f8f8;
            color: var(--text-dark);
            line-height: 1.6;
            padding: 20px;
        }
        
        /* --- Main Container --- */
        .container {
            max-width: 1000px;
            margin: 20px auto;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        /* --- Header --- */
        header {
            background-color: var(--primary-green);
            color: var(--text-light);
            padding: 20px;
            text-align: center;
            font-size: 24px;
            font-weight: bold;
        }
        
        /* --- Instruction Bar --- */
        .instruction-bar {
            background-color: var(--secondary-green);
            color: var(--text-light);
            padding: 15px;
            text-align: center;
            font-size: 16px;
        }
        
        /* --- Calculator Layout --- */
        .calculator-grid {
            display: grid;
            grid-template-columns: 1fr 1fr; /* Two equal columns */
            gap: 30px;
            padding: 30px;
        }
        
        /* --- Input & Results Sections --- */
        .input-section {
            background-color: var(--very-light-green);
            padding: 25px;
            border-radius: 8px;
        }
        
        .results-section {
            display: flex;
            flex-direction: column;
            gap: 20px; /* Space between result blocks */
        }
        
        /* --- Primary Result Display (Monthly Pay / Affordable Price) --- */
        .primary-result {
            background-color: var(--primary-green);
            color: var(--text-light);
            padding: 15px 20px; /* Adjusted padding */
            border-radius: 8px;
            text-align: center;
            font-size: 22px; /* Adjusted size */
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap; /* Allow wrapping for buttons */
            gap: 10px; /* Gap between text and buttons */
        }
         .primary-result-label {
             margin-right: auto; /* Push buttons to the right */
         }
         .primary-result-value {
             font-size: 24px; /* Larger value */
         }
         .primary-result-actions {
             display: flex;
             gap: 8px; /* Space between action buttons */
         }

        /* --- Action Buttons (Copy, Save) --- */
        .action-button {
            background-color: var(--text-light);
            color: var(--primary-green);
            border: 1px solid var(--primary-green);
            border-radius: 4px;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s, color 0.2s;
            display: inline-flex; /* Align icon and text */
            align-items: center;
            gap: 5px;
        }
        
        .action-button:hover {
            background-color: var(--dark-green);
            color: var(--text-light);
        }
        .action-button svg { /* Basic styling for inline SVG icons */
             width: 14px;
             height: 14px;
             fill: currentColor;
         }

        /* --- Detailed Results Block --- */
        .results-detail {
            background-color: var(--very-light-green);
            padding: 20px;
            border-radius: 8px;
        }
        
        .results-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            font-size: 16px;
        }
         .results-row span:first-child {
             color: var(--dark-green);
             font-weight: 500;
             padding-right: 10px; /* Add space between label and value */
         }
         .results-row span:last-child {
             font-weight: bold;
             text-align: right; /* Align value to the right */
         }
        
        /* --- Loan Breakdown Chart Block --- */
        .loan-breakdown {
            background-color: var(--very-light-green);
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }
        
        .breakdown-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: var(--dark-green);
        }
        
        .chart-container {
            width: 180px;
            height: 180px;
            margin: 0 auto 15px auto;
            position: relative;
        }
         .legend-container {
             display: flex;
             justify-content: center;
             gap: 20px;
             margin-top: 10px;
             font-size: 14px;
         }
         .legend-item {
             display: flex;
             align-items: center;
         }
         .legend-color-box {
             width: 15px;
             height: 15px;
             margin-right: 8px;
             border-radius: 3px;
         }
        
        /* --- Input Field Styling --- */
        .input-group {
            margin-bottom: 18px;
        }
        
        label {
            display: block;
            margin-bottom: 6px;
            font-weight: bold;
            color: var(--dark-green);
            font-size: 15px;
        }
        
        .input-field {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--input-border);
            border-radius: 4px;
            font-size: 16px;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
         .input-field:focus {
             border-color: var(--primary-green);
             box-shadow: 0 0 0 2px rgba(46, 139, 87, 0.2);
             outline: none;
         }

        /* Styles for specific input types and adornments */
         input[type="number"].input-field {
             padding-right: 12px;
         }
         input[type="text"].input-field.currency { /* Specific class for currency text inputs */
             padding-left: 28px;
         }
         /* Adjust right padding based on ID for specific number inputs with units */
         #tp-loan-term, #mp-loan-term { padding-right: 65px !important; } /* Needs !important due to specificity */
         #tp-interest-rate, #mp-interest-rate, #tp-sales-tax, #mp-sales-tax { padding-right: 28px !important; }


        /* Container for inputs with symbols */
        .input-with-symbol {
            position: relative;
        }
        
        /* Positioning for symbols/units */
        .currency-symbol, .percent-symbol, .unit-label {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            color: #888;
            pointer-events: none;
            font-size: 16px;
        }
        
        .currency-symbol { left: 10px; }
        .percent-symbol { right: 12px; }
        .unit-label { right: 12px; }
        
        /* --- Tooltip Styling --- */
        .help-icon {
            display: inline-block;
            width: 16px; height: 16px;
            background-color: var(--secondary-green);
            color: white; border-radius: 50%;
            text-align: center; line-height: 16px;
            font-size: 12px; margin-left: 5px;
            cursor: help; vertical-align: middle;
        }
        .tooltip { position: relative; display: inline-block; }
        .tooltip .tooltip-text {
            visibility: hidden; width: 200px;
            background-color: #555; color: #fff;
            text-align: center; border-radius: 6px;
            padding: 8px; position: absolute;
            z-index: 1; bottom: 130%; left: 50%;
            margin-left: -100px; opacity: 0;
            transition: opacity 0.3s; font-size: 12px;
            font-weight: normal; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
         .tooltip .tooltip-text::after {
             content: ""; position: absolute;
             top: 100%; left: 50%; margin-left: -5px;
             border-width: 5px; border-style: solid;
             border-color: #555 transparent transparent transparent;
         }
        .tooltip:hover .tooltip-text { visibility: visible; opacity: 1; }
        
        /* --- Checkbox Styling --- */
        .checkbox-container { display: flex; align-items: center; margin-top: 20px; }
        .checkbox-container input[type="checkbox"] {
            margin-right: 10px; width: 16px; height: 16px;
            accent-color: var(--primary-green); cursor: pointer;
        }
         .checkbox-container label {
             margin-bottom: 0; font-weight: normal;
             color: var(--text-dark); cursor: pointer; font-size: 15px;
         }
        
        /* --- Button Styling --- */
        .calculate-btn {
            background-color: var(--primary-green); color: white;
            border: none; padding: 12px 20px; border-radius: 4px;
            font-size: 16px; font-weight: bold; cursor: pointer;
            width: 100%; margin-top: 25px; display: flex;
            justify-content: center; align-items: center; gap: 10px;
            transition: background-color 0.2s;
        }
        .calculate-btn:hover { background-color: var(--dark-green); }
        
        /* --- Tab Styling --- */
        .tab-container { display: flex; border-bottom: 1px solid var(--light-green); margin-bottom: 25px; }
        .tab {
            padding: 10px 20px; background-color: #e9e9e9; cursor: pointer;
            border-radius: 4px 4px 0 0; margin-right: 5px;
            transition: background-color 0.2s, color 0.2s;
            color: var(--dark-green); font-weight: 500; border: none; /* Ensure button look */
        }
        .tab.active { background-color: var(--secondary-green); color: white; font-weight: bold; }
        .tab:hover:not(.active) { background-color: #dcdcdc; }
        /* Hide inactive tab content */
        .tab-content { display: none; }
        .tab-content.active { display: block; }


        /* --- Message Box Styles --- */
        .message-box-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.5); display: flex;
            justify-content: center; align-items: center; z-index: 1000;
            opacity: 0; visibility: hidden;
            transition: opacity 0.3s ease, visibility 0s linear 0.3s;
        }
        .message-box-overlay.visible { opacity: 1; visibility: visible; transition: opacity 0.3s ease; }
        .message-box {
            background-color: white; padding: 30px; border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2); text-align: center;
            max-width: 300px; transform: scale(0.9); transition: transform 0.3s ease;
        }
        .message-box-overlay.visible .message-box { transform: scale(1); }
        .message-box p { margin-bottom: 20px; font-size: 16px; color: var(--text-dark); }
        .message-box button {
            background-color: var(--primary-green); color: white; border: none;
            padding: 10px 20px; border-radius: 4px; font-size: 14px;
            cursor: pointer; transition: background-color 0.2s;
        }
        .message-box button:hover { background-color: var(--dark-green); }

        /* --- Amortization Schedule Styles --- */
        .amortization-schedule {
            background-color: var(--very-light-green);
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px; /* Add space above */
        }
        .amortization-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: var(--dark-green);
            text-align: center;
        }
        .amortization-table-container {
             max-height: 400px; /* Limit height and make scrollable */
             overflow-y: auto;
             border: 1px solid var(--table-border-color); /* Add border around scroll area */
             border-radius: 4px;
         }
        .amortization-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px; /* Slightly smaller font for table */
        }
        .amortization-table thead th {
            background-color: var(--light-green); /* Header background */
            color: var(--dark-green);
            padding: 8px 10px;
            text-align: right;
            position: sticky; /* Keep header visible when scrolling */
            top: 0;
            z-index: 1;
        }
        .amortization-table thead th:first-child {
             text-align: left; /* Align month left */
         }
        .amortization-table tbody tr:nth-child(even) {
            background-color: #f8f9fa; /* Zebra striping */
        }
        .amortization-table tbody tr:hover {
             background-color: #e9ecef; /* Hover effect */
         }
        .amortization-table td {
            border-top: 1px solid var(--table-border-color);
            padding: 6px 10px;
            text-align: right;
        }
         .amortization-table td:first-child {
             text-align: left; /* Align month left */
         }

        
        /* --- Responsive Design --- */
        @media (max-width: 768px) {
            .calculator-grid { grid-template-columns: 1fr; gap: 20px; padding: 20px; }
            .input-section, .results-detail, .loan-breakdown, .amortization-schedule { padding: 20px; } /* Apply padding */
            .chart-container { width: 150px; height: 150px; }
            header { font-size: 20px; }
            .primary-result { font-size: 20px; padding: 15px; }
            .primary-result-value { font-size: 22px; }
             .results-row { font-size: 15px; }
             .tab { padding: 8px 15px; font-size: 14px; }
             .amortization-table { font-size: 13px; } /* Smaller font on mobile */
             .amortization-table thead th, .amortization-table td { padding: 5px 8px; }
        }
         @media (max-width: 480px) {
             body { padding: 10px; }
             .container { margin: 10px auto; }
             .calculator-grid { padding: 15px; }
              .input-section, .results-detail, .loan-breakdown, .amortization-schedule { padding: 15px; } /* Apply padding */
             header { font-size: 18px; padding: 15px; }
             .instruction-bar { font-size: 14px; padding: 10px; }
             .primary-result { font-size: 18px; padding: 12px; flex-direction: column; gap: 5px; align-items: stretch; }
             .primary-result-label { margin-right: 0; text-align: center;}
             .primary-result-value { text-align: center; }
             .primary-result-actions { justify-content: center; margin-top: 10px;}
             .results-row { font-size: 14px; margin-bottom: 10px; }
             .calculate-btn { font-size: 15px; padding: 10px 15px; }
             .checkbox-container label { font-size: 14px; }
             .amortization-table { font-size: 12px; }
             .amortization-table thead th, .amortization-table td { padding: 4px 6px; }
             .amortization-table-container { max-height: 300px; } /* Adjust height */
         }

    </style>
</head>
<body>
    <div class="container">
        <header>Auto Loan Calculator</header>
        <div class="instruction-bar">
            <i class="arrow-down">▼</i> Select a tab, modify values, and click Calculate
        </div>
        
        <div class="calculator-grid">
            <div class="input-section">
                <div class="tab-container">
                    <button class="tab active" onclick="switchTab('total-price', this)">Total Price</button>
                    <button class="tab" onclick="switchTab('monthly-payment', this)">Monthly Payment</button>
                </div>
                
                <div class="tab-content active" id="total-price-tab">
                    <p style="font-size: 0.9em; color: var(--secondary-green); margin-bottom: 15px;">Calculate your monthly payment based on the vehicle price.</p>
                    <div class="input-group"> <label for="tp-auto-price">Auto Price</label> <div class="input-with-symbol"> <span class="currency-symbol">$</span> <input type="text" id="tp-auto-price" class="input-field currency" value="50,000" inputmode="decimal" aria-label="Auto Price in dollars"> </div> </div>
                    <div class="input-group"> <label for="tp-loan-term">Loan Term</label> <div class="input-with-symbol"> <input type="number" id="tp-loan-term" class="input-field" value="60" min="1" aria-label="Loan term in months"> <span class="unit-label">months</span> </div> </div>
                    <div class="input-group"> <label for="tp-interest-rate">Interest Rate</label> <div class="input-with-symbol input-with-percent"> <input type="number" id="tp-interest-rate" class="input-field" value="5" step="0.01" min="0" aria-label="Annual interest rate percentage"> <span class="percent-symbol">%</span> </div> </div>
                    <div class="input-group"> <label for="tp-cash-incentives">Cash Incentives <div class="tooltip"><span class="help-icon">?</span><span class="tooltip-text">Manufacturer rebates or other cash incentives applied before tax.</span></div></label> <div class="input-with-symbol"> <span class="currency-symbol">$</span> <input type="text" id="tp-cash-incentives" class="input-field currency" value="0" inputmode="decimal" aria-label="Cash incentives in dollars"> </div> </div>
                    <div class="input-group"> <label for="tp-down-payment">Down Payment <div class="tooltip"><span class="help-icon">?</span><span class="tooltip-text">The initial cash payment you make toward the purchase.</span></div></label> <div class="input-with-symbol"> <span class="currency-symbol">$</span> <input type="text" id="tp-down-payment" class="input-field currency" value="10,000" inputmode="decimal" aria-label="Down payment in dollars"> </div> </div>
                    <div class="input-group"> <label for="tp-trade-in-value">Trade-in Value <div class="tooltip"><span class="help-icon">?</span><span class="tooltip-text">The value of your current vehicle that you're trading in.</span></div></label> <div class="input-with-symbol"> <span class="currency-symbol">$</span> <input type="text" id="tp-trade-in-value" class="input-field currency" value="0" inputmode="decimal" aria-label="Trade-in value in dollars"> </div> </div>
                    <div class="input-group"> <label for="tp-amount-owed">Amount Owed on Trade-in <div class="tooltip"><span class="help-icon">?</span><span class="tooltip-text">The remaining amount you owe on your trade-in vehicle (negative equity).</span></div></label> <div class="input-with-symbol"> <span class="currency-symbol">$</span> <input type="text" id="tp-amount-owed" class="input-field currency" value="0" inputmode="decimal" aria-label="Amount owed on trade-in in dollars"> </div> </div>
                    <div class="input-group"> <label for="tp-state">Your State (Affects Tax/Fees)</label> <select id="tp-state" class="input-field" aria-label="Select your state"> <option value="AL">Alabama</option> <option value="AK">Alaska</option> <option value="AZ">Arizona</option> <option value="AR">Arkansas</option> <option value="CA">California</option> <option value="CO">Colorado</option> <option value="CT">Connecticut</option> <option value="DE">Delaware</option> <option value="FL">Florida</option> <option value="GA">Georgia</option> <option value="HI">Hawaii</option> <option value="ID">Idaho</option> <option value="IL">Illinois</option> <option value="IN">Indiana</option> <option value="IA">Iowa</option> <option value="KS">Kansas</option> <option value="KY">Kentucky</option> <option value="LA">Louisiana</option> <option value="ME">Maine</option> <option value="MD">Maryland</option> <option value="MA">Massachusetts</option> <option value="MI">Michigan</option> <option value="MN">Minnesota</option> <option value="MS">Mississippi</option> <option value="MO">Missouri</option> <option value="MT">Montana</option> <option value="NE">Nebraska</option> <option value="NV">Nevada</option> <option value="NH">New Hampshire</option> <option value="NJ">New Jersey</option> <option value="NM">New Mexico</option> <option value="NY">New York</option> <option value="NC" selected>North Carolina</option> <option value="ND">North Dakota</option> <option value="OH">Ohio</option> <option value="OK">Oklahoma</option> <option value="OR">Oregon</option> <option value="PA">Pennsylvania</option> <option value="RI">Rhode Island</option> <option value="SC">South Carolina</option> <option value="SD">South Dakota</option> <option value="TN">Tennessee</option> <option value="TX">Texas</option> <option value="UT">Utah</option> <option value="VT">Vermont</option> <option value="VA">Virginia</option> <option value="WA">Washington</option> <option value="WV">West Virginia</option> <option value="WI">Wisconsin</option> <option value="WY">Wyoming</option> </select> </div>
                    <div class="input-group"> <label for="tp-sales-tax">Sales Tax Rate <div class="tooltip"><span class="help-icon">?</span><span class="tooltip-text">State vehicle sales tax rate. Trade-in value may reduce taxable amount in some states.</span></div></label> <div class="input-with-symbol input-with-percent"> <input type="number" id="tp-sales-tax" class="input-field" value="3" step="0.01" min="0" aria-label="Sales tax rate percentage"> <span class="percent-symbol">%</span> </div> </div>
                    <div class="input-group"> <label for="tp-title-fees">Title, Registration & Other Fees <div class="tooltip"><span class="help-icon">?</span><span class="tooltip-text">Estimated fees for title, registration, documentation, etc. Varies by state/dealer.</span></div></label> <div class="input-with-symbol"> <span class="currency-symbol">$</span> <input type="text" id="tp-title-fees" class="input-field currency" value="200" inputmode="decimal" aria-label="Title, registration and other fees in dollars"> </div> </div>
                    <div class="checkbox-container"> <input type="checkbox" id="tp-include-fees" checked aria-labelledby="tp-include-fees-label"> <label for="tp-include-fees" id="tp-include-fees-label">Include All Taxes & Fees in Loan</label> </div>
                    <button class="calculate-btn" onclick="calculateLoan()"> Calculate Monthly Payment <span>►</span> </button>
                </div>

                <div class="tab-content" id="monthly-payment-tab">
                     <p style="font-size: 0.9em; color: var(--secondary-green); margin-bottom: 15px;">Calculate the affordable vehicle price based on your desired monthly payment.</p>
                    <div class="input-group"> <label for="mp-monthly-payment">Desired Monthly Payment</label> <div class="input-with-symbol"> <span class="currency-symbol">$</span> <input type="text" id="mp-monthly-payment" class="input-field currency" value="750.00" inputmode="decimal" aria-label="Desired monthly payment in dollars"> </div> </div>
                    <div class="input-group"> <label for="mp-loan-term">Loan Term</label> <div class="input-with-symbol"> <input type="number" id="mp-loan-term" class="input-field" value="60" min="1" aria-label="Loan term in months"> <span class="unit-label">months</span> </div> </div>
                    <div class="input-group"> <label for="mp-interest-rate">Interest Rate</label> <div class="input-with-symbol input-with-percent"> <input type="number" id="mp-interest-rate" class="input-field" value="5" step="0.01" min="0" aria-label="Annual interest rate percentage"> <span class="percent-symbol">%</span> </div> </div>
                    <div class="input-group"> <label for="mp-cash-incentives">Cash Incentives <div class="tooltip"><span class="help-icon">?</span><span class="tooltip-text">Manufacturer rebates or other cash incentives applied before tax.</span></div></label> <div class="input-with-symbol"> <span class="currency-symbol">$</span> <input type="text" id="mp-cash-incentives" class="input-field currency" value="0" inputmode="decimal" aria-label="Cash incentives in dollars"> </div> </div>
                    <div class="input-group"> <label for="mp-down-payment">Down Payment <div class="tooltip"><span class="help-icon">?</span><span class="tooltip-text">The initial cash payment you make toward the purchase.</span></div></label> <div class="input-with-symbol"> <span class="currency-symbol">$</span> <input type="text" id="mp-down-payment" class="input-field currency" value="10,000" inputmode="decimal" aria-label="Down payment in dollars"> </div> </div>
                    <div class="input-group"> <label for="mp-trade-in-value">Trade-in Value <div class="tooltip"><span class="help-icon">?</span><span class="tooltip-text">The value of your current vehicle that you're trading in.</span></div></label> <div class="input-with-symbol"> <span class="currency-symbol">$</span> <input type="text" id="mp-trade-in-value" class="input-field currency" value="0" inputmode="decimal" aria-label="Trade-in value in dollars"> </div> </div>
                    <div class="input-group"> <label for="mp-amount-owed">Amount Owed on Trade-in <div class="tooltip"><span class="help-icon">?</span><span class="tooltip-text">The remaining amount you owe on your trade-in vehicle (negative equity).</span></div></label> <div class="input-with-symbol"> <span class="currency-symbol">$</span> <input type="text" id="mp-amount-owed" class="input-field currency" value="0" inputmode="decimal" aria-label="Amount owed on trade-in in dollars"> </div> </div>
                    <div class="input-group"> <label for="mp-state">Your State (Affects Tax/Fees)</label> <select id="mp-state" class="input-field" aria-label="Select your state"> <option value="AL">Alabama</option> <option value="AK">Alaska</option> <option value="AZ">Arizona</option> <option value="AR">Arkansas</option> <option value="CA">California</option> <option value="CO">Colorado</option> <option value="CT">Connecticut</option> <option value="DE">Delaware</option> <option value="FL">Florida</option> <option value="GA">Georgia</option> <option value="HI">Hawaii</option> <option value="ID">Idaho</option> <option value="IL">Illinois</option> <option value="IN">Indiana</option> <option value="IA">Iowa</option> <option value="KS">Kansas</option> <option value="KY">Kentucky</option> <option value="LA">Louisiana</option> <option value="ME">Maine</option> <option value="MD">Maryland</option> <option value="MA">Massachusetts</option> <option value="MI">Michigan</option> <option value="MN">Minnesota</option> <option value="MS">Mississippi</option> <option value="MO">Missouri</option> <option value="MT">Montana</option> <option value="NE">Nebraska</option> <option value="NV">Nevada</option> <option value="NH">New Hampshire</option> <option value="NJ">New Jersey</option> <option value="NM">New Mexico</option> <option value="NY">New York</option> <option value="NC" selected>North Carolina</option> <option value="ND">North Dakota</option> <option value="OH">Ohio</option> <option value="OK">Oklahoma</option> <option value="OR">Oregon</option> <option value="PA">Pennsylvania</option> <option value="RI">Rhode Island</option> <option value="SC">South Carolina</option> <option value="SD">South Dakota</option> <option value="TN">Tennessee</option> <option value="TX">Texas</option> <option value="UT">Utah</option> <option value="VT">Vermont</option> <option value="VA">Virginia</option> <option value="WA">Washington</option> <option value="WV">West Virginia</option> <option value="WI">Wisconsin</option> <option value="WY">Wyoming</option> </select> </div>
                    <div class="input-group"> <label for="mp-sales-tax">Sales Tax Rate <div class="tooltip"><span class="help-icon">?</span><span class="tooltip-text">State vehicle sales tax rate. Trade-in value may reduce taxable amount in some states.</span></div></label> <div class="input-with-symbol input-with-percent"> <input type="number" id="mp-sales-tax" class="input-field" value="3" step="0.01" min="0" aria-label="Sales tax rate percentage"> <span class="percent-symbol">%</span> </div> </div>
                    <div class="input-group"> <label for="mp-title-fees">Title, Registration & Other Fees <div class="tooltip"><span class="help-icon">?</span><span class="tooltip-text">Estimated fees for title, registration, documentation, etc. Varies by state/dealer.</span></div></label> <div class="input-with-symbol"> <span class="currency-symbol">$</span> <input type="text" id="mp-title-fees" class="input-field currency" value="200" inputmode="decimal" aria-label="Title, registration and other fees in dollars"> </div> </div>
                    <div class="checkbox-container"> <input type="checkbox" id="mp-include-fees" checked aria-labelledby="mp-include-fees-label"> <label for="mp-include-fees" id="mp-include-fees-label">Include All Taxes & Fees in Loan</label> </div>
                    <button class="calculate-btn" onclick="calculateLoan()"> Calculate Affordable Price <span>►</span> </button>
                </div>
            </div>
            
            <div class="results-section">
                <div class="primary-result" aria-live="polite">
                    <span id="primary-result-label">Monthly Pay:</span>
                    <span id="primary-result-value">$0.00</span>
                    <div class="primary-result-actions">
                         <button class="action-button" id="copy-button" onclick="copyPrimaryResult()" aria-label="Copy primary result amount">
                             <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="14" height="14" fill="currentColor"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>
                             Copy
                         </button>
                         <button class="action-button" id="save-button" onclick="saveResultsAsPDF()" aria-label="Save results as PDF">
                             <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="14" height="14" fill="currentColor"><path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm2 16H5V5h11.17L19 7.83V19zm-7-7c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3zM6 6h9v4H6z"/></svg>
                             Save
                         </button>
                    </div>
                </div>
                
                <div class="results-detail" aria-live="polite">
                    <div class="results-row" id="affordable-price-row" style="display: none;"> 
                        <span>Affordable Auto Price</span>
                        <span id="affordable-price-result">$0.00</span>
                    </div>
                    <div class="results-row"> <span>Total Loan Amount</span> <span id="total-loan">$0.00</span> </div>
                    <div class="results-row"> <span>Sale Tax Amount</span> <span id="sale-tax">$0.00</span> </div>
                    <div class="results-row"> <span>Total Fees</span> <span id="total-fees">$0.00</span> </div>
                    <div class="results-row"> <span>Upfront Payment</span> <span id="upfront-payment">$0.00</span> </div>
                    <div class="results-row"> <span id="loan-payments-text">Total of 60 Loan Payments</span> <span id="loan-payments">$0.00</span> </div>
                    <div class="results-row"> <span>Total Loan Interest</span> <span id="loan-interest">$0.00</span> </div>
                    <div class="results-row"> <span>Total Cost (Price + Interest + Tax + Fees)</span> <span id="total-cost">$0.00</span> </div>
                </div>
                
                <div class="loan-breakdown">
                    <div class="breakdown-title">Loan Payment Breakdown</div>
                    <div class="chart-container" role="img" aria-label="Loan breakdown chart showing principal vs interest">
                        <canvas id="pie-chart"></canvas>
                    </div>
                    <div class="legend-container">
                        <div class="legend-item"> <div class="legend-color-box" style="background-color: #4169e1;"></div> <span>Principal</span> </div>
                        <div class="legend-item"> <div class="legend-color-box" style="background-color: #32cd32;"></div> <span>Interest</span> </div>
                    </div>
                </div>

                 <div class="amortization-schedule" id="amortization-schedule">
                     <div class="amortization-title">Amortization Schedule</div>
                     <div class="amortization-table-container">
                         <table class="amortization-table">
                             <thead>
                                 <tr>
                                     <th>Month</th>
                                     <th>Payment</th>
                                     <th>Principal</th>
                                     <th>Interest</th>
                                     <th>Balance</th>
                                 </tr>
                             </thead>
                             <tbody id="amortization-tbody">
                                 <tr><td colspan="5" style="text-align: center; padding: 20px;">Enter loan details and click Calculate to see the schedule.</td></tr>
                             </tbody>
                         </table>
                     </div>
                 </div>

            </div>
        </div>
    </div>

    <div id="message-box-overlay" class="message-box-overlay" role="alertdialog" aria-modal="true" aria-labelledby="message-box-text">
        <div class="message-box">
            <p id="message-box-text">Message goes here</p>
            <button onclick="hideMessageBox()">OK</button>
        </div>
    </div>
    
    <script>
        // Global variables
        let chart = null;
        let currentCalcMode = 'total-price'; // 'total-price' or 'monthly-payment'

        // --- Formatting Functions ---
        function formatCurrency(amount) { 
            const numericAmount = typeof amount === 'number' && !isNaN(amount) ? amount : 0;
            try {
                return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(numericAmount);
            } catch (error) { console.error("Error formatting currency:", error); return "$0.00"; }
        }
        // Simpler number formatting for table values (less overhead than full currency)
         function formatTableNumber(amount) {
             const numericAmount = typeof amount === 'number' && !isNaN(amount) ? amount : 0;
             return numericAmount.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
         }
        function formatNumberStringWithCommas(numStr) { 
             if (typeof numStr !== 'string' || !numStr) return '';
             const parts = numStr.split('.');
             parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
             return parts.join('.');
        }
        function parseNumericInput(inputId) { 
            const inputElement = document.getElementById(inputId);
            let value = '';
            if (!inputElement) { 
                console.error(`Element with ID "${inputId}" not found.`); 
                return 0; 
            } else if (inputElement.tagName === 'INPUT' || inputElement.tagName === 'TEXTAREA') {
                 value = inputElement.value;
            } else if (inputElement.tagName === 'SPAN') {
                 value = inputElement.textContent;
            } else {
                 console.error(`Element with ID "${inputId}" is not an input or span.`); 
                 return 0;
            }
            const cleanedValue = value.replace(/[$,]/g, '').replace(/[^\d.]/g, ''); 
            const parsedValue = parseFloat(cleanedValue);
            return isNaN(parsedValue) ? 0 : parsedValue;
        }
        function setupCurrencyInputFormatting(inputId) { 
            const input = document.getElementById(inputId);
            if (!input || input.type !== 'text') {
                 if (inputId !== 'mp-monthly-payment' && inputId !== 'tp-auto-price') {
                      // console.warn(`setupCurrencyInputFormatting: Element ID "${inputId}" not found or not type="text".`);
                 }
                 if (!input) return; 
            }
            
            // Input event listener
             input.addEventListener('input', function(e) {
                 const originalValue = this.value;
                 const cursorPosition = this.selectionStart; 
                 const originalLength = originalValue.length;
                 let numericValue = originalValue.replace(/[^\d.]/g, '');
                 const parts = numericValue.split('.');
                 if (parts.length > 2) { numericValue = parts[0] + '.' + parts.slice(1).join(''); }
                 if (parts[1] && parts[1].length > 2) { numericValue = parts[0] + '.' + parts[1].substring(0, 2); }
                 const formattedValue = formatNumberStringWithCommas(numericValue);
                 if (this.value !== formattedValue) {
                    this.value = formattedValue;
                    const newLength = formattedValue.length;
                    let newCursorPosition = cursorPosition;
                    const commasBeforeCursorOriginal = (originalValue.substring(0, cursorPosition).match(/,/g) || []).length;
                    const commasBeforeCursorNew = (formattedValue.substring(0, cursorPosition + (newLength - originalLength)).match(/,/g) || []).length;
                    newCursorPosition += (commasBeforeCursorNew - commasBeforeCursorOriginal);
                    if (newCursorPosition < 0) newCursorPosition = 0;
                    if (newCursorPosition > newLength) newCursorPosition = newLength;
                    if (document.activeElement === this) {
                         this.setSelectionRange(newCursorPosition, newCursorPosition);
                    }
                 }
             });

             // Blur event listener
             input.addEventListener('blur', function() {
                 const numericValue = parseNumericInput(inputId);
                 if (this.value.trim() === '' && numericValue === 0) {
                      this.value = ''; 
                 } else {
                      this.value = formatNumberStringWithCommas(numericValue.toFixed(2)); 
                 }
             });
        }

        // --- Chart Function ---
        function initializeChart(principal, interest) { 
            const ctx = document.getElementById('pie-chart')?.getContext('2d');
            if (!ctx) { console.error("Canvas context 'pie-chart' not found."); return; }
            const safePrincipal = Math.max(0, isNaN(principal) ? 0 : principal);
            const safeInterest = Math.max(0, isNaN(interest) ? 0 : interest);
            const total = safePrincipal + safeInterest;
            const chartData = { 
                labels: ['Principal', 'Interest'], 
                datasets: [{ 
                    data: total > 0 ? [safePrincipal, safeInterest] : [1, 0], 
                    backgroundColor: total > 0 ? ['#4169e1', '#32cd32'] : ['#e0e0e0', '#e0e0e0'], 
                    borderColor: '#ffffff', 
                    borderWidth: total > 0 ? 2 : 0 
                }] 
            };
            if (chart) { chart.destroy(); }
            chart = new Chart(ctx, { 
                type: 'doughnut', 
                data: chartData, 
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    cutout: '70%', 
                    plugins: { 
                        legend: { display: false }, 
                        tooltip: { 
                            enabled: total > 0, 
                            callbacks: { label: function(context) { return `${context.label || ''}: ${formatCurrency(context.raw)}`; } } 
                        } 
                    }, 
                    circumference: total > 0 ? 360 : 0, 
                    animation: { duration: total > 0 ? 1000 : 0 } 
                } 
            });
        }

        // --- Amortization Schedule Functions ---
        /**
         * Generates the amortization schedule data.
         * @param {number} principal - The starting loan principal.
         * @param {number} annualRate - The annual interest rate (as percentage).
         * @param {number} termMonths - The loan term in months.
         * @param {number} monthlyPayment - The calculated monthly payment.
         * @returns {Array<object>} An array of objects, each representing a row in the schedule.
         */
        function generateAmortizationSchedule(principal, annualRate, termMonths, monthlyPayment) {
            const schedule = [];
            if (principal <= 0 || termMonths <= 0 || isNaN(principal) || isNaN(termMonths) || isNaN(monthlyPayment)) {
                return schedule; // Return empty if inputs are invalid
            }

            let balance = principal;
            const monthlyRate = annualRate / 100.0 / 12.0;

            for (let month = 1; month <= termMonths; month++) {
                const interestForMonth = balance * monthlyRate;
                let principalForMonth = monthlyPayment - interestForMonth;
                
                // Adjust last payment to ensure balance hits zero due to potential rounding
                if (month === termMonths) {
                     // If the calculated principal is slightly more than the balance, adjust it
                     if (principalForMonth > balance + 0.001) { // Allow for tiny float errors
                          principalForMonth = balance;
                          monthlyPayment = principalForMonth + interestForMonth; // Adjust final payment amount
                     }
                     balance = 0; // Force balance to zero on last payment
                } else {
                     balance -= principalForMonth;
                }

                // Ensure principal isn't negative if payment doesn't cover interest (unlikely with valid inputs)
                principalForMonth = Math.max(0, principalForMonth); 
                // Ensure balance isn't negative
                balance = Math.max(0, balance); 

                schedule.push({
                    month: month,
                    payment: monthlyPayment,
                    principal: principalForMonth,
                    interest: interestForMonth,
                    balance: balance
                });
            }
            return schedule;
        }

        /**
         * Populates the HTML table with amortization data.
         * @param {Array<object>} scheduleData - Data generated by generateAmortizationSchedule.
         */
        function displayAmortizationSchedule(scheduleData) {
            const tbody = document.getElementById('amortization-tbody');
            if (!tbody) return;

            // Clear previous schedule
            tbody.innerHTML = ''; 

            if (!scheduleData || scheduleData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px;">Amortization schedule requires a valid loan amount and term.</td></tr>';
                return;
            }

            // Populate table rows
            scheduleData.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${row.month}</td>
                    <td>${formatTableNumber(row.payment)}</td>
                    <td>${formatTableNumber(row.principal)}</td>
                    <td>${formatTableNumber(row.interest)}</td>
                    <td>${formatTableNumber(row.balance)}</td>
                `;
                tbody.appendChild(tr);
            });
        }


        // --- Calculation Logic ---
        /**
         * Main calculation function. Gathers inputs, performs calculations based on mode,
         * updates UI results, chart, and amortization schedule.
         */
        function calculateLoan() {
            const prefix = currentCalcMode === 'total-price' ? 'tp-' : 'mp-';
            const loanTerm = parseInt(document.getElementById(prefix + 'loan-term').value) || 0;
            const annualInterestRate = parseFloat(document.getElementById(prefix + 'interest-rate').value) || 0;
            const cashIncentives = parseNumericInput(prefix + 'cash-incentives');
            const downPayment = parseNumericInput(prefix + 'down-payment');
            const tradeInValue = parseNumericInput(prefix + 'trade-in-value');
            const amountOwed = parseNumericInput(prefix + 'amount-owed');
            const salesTaxRate = parseFloat(document.getElementById(prefix + 'sales-tax').value) || 0;
            const titleFees = parseNumericInput(prefix + 'title-fees');
            const includeFees = document.getElementById(prefix + 'include-fees').checked;

            let autoPrice = 0, monthlyPayment = 0, loanAmount = 0, salesTaxAmount = 0;
            let totalInterest = 0, totalPayments = 0, upfrontPayment = 0, totalCost = 0;
            
            const netTradeIn = tradeInValue - amountOwed;
            const positiveTradeEquity = Math.max(0, netTradeIn);
            const negativeEquity = Math.max(0, -netTradeIn);

             if (loanTerm <= 0) { showMessageBox("Please enter a valid Loan Term (> 0 months)."); return; }
             if (annualInterestRate < 0) { showMessageBox("Interest Rate cannot be negative."); return; }
             if (cashIncentives < 0 || downPayment < 0 || tradeInValue < 0 || amountOwed < 0 || titleFees < 0 || salesTaxRate < 0) {
                 showMessageBox("Currency values and tax rate cannot be negative."); return;
             }

            if (currentCalcMode === 'total-price') {
                autoPrice = parseNumericInput('tp-auto-price');
                if (autoPrice <= 0) { showMessageBox("Please enter a valid Auto Price (> 0)."); return; }
                const baseForTax = Math.max(0, autoPrice - cashIncentives - positiveTradeEquity);
                salesTaxAmount = baseForTax * (salesTaxRate / 100.0);
                const totalTaxesAndFees = salesTaxAmount + titleFees;
                loanAmount = autoPrice - cashIncentives - downPayment - positiveTradeEquity + negativeEquity;
                if (includeFees) { loanAmount += totalTaxesAndFees; }
                loanAmount = Math.max(0, loanAmount);

                if (loanAmount > 0 && loanTerm > 0) {
                    if (annualInterestRate === 0) {
                        monthlyPayment = loanAmount / loanTerm; totalInterest = 0;
                    } else {
                        const i = annualInterestRate / 100.0 / 12.0; const n = loanTerm; const p = loanAmount;
                        const factor = Math.pow(1 + i, n);
                        monthlyPayment = p * (i * factor) / (factor - 1);
                        totalPayments = monthlyPayment * n; totalInterest = totalPayments - p;
                    }
                }
            } else { 
                monthlyPayment = parseNumericInput('mp-monthly-payment');
                if (monthlyPayment <= 0) { showMessageBox("Please enter a valid Desired Monthly Payment (> 0)."); return; }
                 if (loanTerm > 0) {
                     if (annualInterestRate === 0) {
                         loanAmount = monthlyPayment * loanTerm; totalInterest = 0;
                     } else {
                         const i = annualInterestRate / 100.0 / 12.0; const n = loanTerm;
                         const factor = Math.pow(1 + i, n);
                         if (i === 0 || factor === 1) { loanAmount = monthlyPayment * n; totalInterest = 0; } 
                         else {
                              loanAmount = monthlyPayment * (factor - 1) / (i * factor);
                              totalPayments = monthlyPayment * n; totalInterest = totalPayments - loanAmount;
                         }
                         if (isNaN(loanAmount) || !isFinite(loanAmount)) loanAmount = 0; 
                         if (isNaN(totalInterest) || !isFinite(totalInterest)) totalInterest = 0;
                     }
                 }
                 loanAmount = Math.max(0, loanAmount); 
                 const TR = salesTaxRate / 100.0; const CI = cashIncentives; const DP = downPayment;
                 const PTE = positiveTradeEquity; const NE = negativeEquity; const TF = titleFees;
                if (includeFees) {
                     const num = loanAmount + CI + DP + PTE - NE + (CI + PTE) * TR - TF;
                     const den = 1.0 + TR;
                     autoPrice = (den !== 0) ? num / den : 0; 
                } else { autoPrice = loanAmount + CI + DP + PTE - NE; }
                 autoPrice = Math.max(0, autoPrice); 
                 const baseForTax = Math.max(0, autoPrice - cashIncentives - positiveTradeEquity);
                 salesTaxAmount = baseForTax * TR;
            }

            // Calculate common results
            const totalTaxesAndFees = salesTaxAmount + titleFees;
            upfrontPayment = downPayment + positiveTradeEquity;
            if (!includeFees) { upfrontPayment += totalTaxesAndFees; }
            // Recalculate total payments if not already done (e.g., in 0% case for total-price mode)
             if (totalPayments === 0 && loanAmount > 0) {
                 totalPayments = monthlyPayment * loanTerm;
             }
            totalCost = autoPrice + totalInterest + totalTaxesAndFees + negativeEquity - cashIncentives;

            // --- Update UI ---
            updateResultsUI({ mode: currentCalcMode, monthlyPayment, affordablePrice: autoPrice, loanAmount, salesTaxAmount, titleFees, upfrontPayment, loanTerm, totalPayments, totalInterest, totalCost });
            initializeChart(loanAmount, totalInterest);

            // --- Generate and Display Amortization Schedule ---
            const scheduleData = generateAmortizationSchedule(loanAmount, annualInterestRate, loanTerm, monthlyPayment);
            displayAmortizationSchedule(scheduleData);
        }

        // --- Update Results UI Function ---
        function updateResultsUI(results) { /* ... (same as before) ... */ 
            const primaryLabelEl = document.getElementById('primary-result-label');
            const primaryValueEl = document.getElementById('primary-result-value');
            const affordablePriceRowEl = document.getElementById('affordable-price-row');
            const affordablePriceResultEl = document.getElementById('affordable-price-result');
            if (results.mode === 'total-price') {
                primaryLabelEl.textContent = 'Monthly Pay:';
                primaryValueEl.textContent = formatCurrency(results.monthlyPayment);
                affordablePriceRowEl.style.display = 'none'; 
            } else { 
                primaryLabelEl.textContent = 'Affordable Price:';
                primaryValueEl.textContent = formatCurrency(results.affordablePrice);
                affordablePriceResultEl.textContent = formatCurrency(results.affordablePrice);
                affordablePriceRowEl.style.display = 'flex'; 
            }
            document.getElementById('total-loan').textContent = formatCurrency(results.loanAmount);
            document.getElementById('sale-tax').textContent = formatCurrency(results.salesTaxAmount);
            document.getElementById('total-fees').textContent = formatCurrency(results.titleFees);
            document.getElementById('upfront-payment').textContent = formatCurrency(results.upfrontPayment);
            document.getElementById('loan-payments-text').textContent = `Total of ${results.loanTerm} Loan Payments`;
            document.getElementById('loan-payments').textContent = formatCurrency(results.totalPayments);
            document.getElementById('loan-interest').textContent = formatCurrency(results.totalInterest);
            document.getElementById('total-cost').textContent = formatCurrency(results.totalCost);
        }

        // --- UI Interaction Functions ---
        function copyPrimaryResult() { /* ... (same as before) ... */ 
             const valueElement = document.getElementById('primary-result-value');
             if (!valueElement) return;
             const valueText = valueElement.textContent;
             if (navigator.clipboard && navigator.clipboard.writeText) {
                  navigator.clipboard.writeText(valueText)
                      .then(() => showMessageBox('Result copied to clipboard!'))
                      .catch(err => { console.error('Copy failed: ', err); showMessageBox('Could not copy result.'); });
             } else { /* Fallback */ 
                  try { /* ... fallback logic ... */ } catch (err) { showMessageBox('Copy failed.'); }
             }
        }
        function showMessageBox(message) { /* ... (same as before) ... */ 
            const overlay = document.getElementById('message-box-overlay');
            const textElement = document.getElementById('message-box-text');
            if (overlay && textElement) { textElement.textContent = message; overlay.classList.add('visible'); } 
            else { alert(message); console.error("Message box elements not found."); }
        }
        function hideMessageBox() { /* ... (same as before) ... */ 
            const overlay = document.getElementById('message-box-overlay');
            if (overlay) { overlay.classList.remove('visible'); }
        }
        function switchTab(tabIdToShow, clickedTabElement) { /* ... (same as before) ... */ 
            if (currentCalcMode === tabIdToShow && clickedTabElement.classList.contains('active')) { return; }
            currentCalcMode = tabIdToShow; 
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            clickedTabElement.classList.add('active');
            const contentBlocks = document.querySelectorAll('.tab-content');
            contentBlocks.forEach(block => { block.style.display = 'none'; block.classList.remove('active'); });
            const activeContent = document.getElementById(tabIdToShow + '-tab');
            if (activeContent) { activeContent.style.display = 'block'; activeContent.classList.add('active'); }
            const calcButton = activeContent?.querySelector('.calculate-btn'); 
            const primaryLabelEl = document.getElementById('primary-result-label');
            if (tabIdToShow === 'total-price') {
                if(calcButton) calcButton.innerHTML = 'Calculate Monthly Payment <span>►</span>';
                if(primaryLabelEl) primaryLabelEl.textContent = 'Monthly Pay:';
            } else {
                 if(calcButton) calcButton.innerHTML = 'Calculate Affordable Price <span>►</span>';
                 if(primaryLabelEl) primaryLabelEl.textContent = 'Affordable Price:';
            }
            calculateLoan();
        }

        // --- PDF Generation ---
        function saveResultsAsPDF() { /* ... (same as before - does NOT include amortization schedule) ... */ 
            try {
                const { jsPDF } = window.jspdf; 
                if (!jsPDF) { showMessageBox("Error: PDF library (jsPDF) not loaded."); return; }
                const doc = new jsPDF();
                const prefix = currentCalcMode === 'total-price' ? 'tp-' : 'mp-';
                const inputs = {
                    mode: currentCalcMode === 'total-price' ? "Calculate Monthly Payment" : "Calculate Affordable Price",
                    autoPriceOrMonthlyPayLabel: currentCalcMode === 'total-price' ? "Auto Price" : "Desired Monthly Payment",
                    autoPriceOrMonthlyPayValue: currentCalcMode === 'total-price' ? formatCurrency(parseNumericInput('tp-auto-price')) : formatCurrency(parseNumericInput('mp-monthly-payment')),
                    loanTerm: parseInt(document.getElementById(prefix + 'loan-term').value) || 0,
                    interestRate: parseFloat(document.getElementById(prefix + 'interest-rate').value) || 0,
                    cashIncentives: formatCurrency(parseNumericInput(prefix + 'cash-incentives')),
                    downPayment: formatCurrency(parseNumericInput(prefix + 'down-payment')),
                    tradeInValue: formatCurrency(parseNumericInput(prefix + 'trade-in-value')),
                    amountOwed: formatCurrency(parseNumericInput(prefix + 'amount-owed')),
                    state: document.getElementById(prefix + 'state').selectedOptions[0]?.text || 'N/A',
                    salesTaxRate: parseFloat(document.getElementById(prefix + 'sales-tax').value) || 0,
                    titleFees: formatCurrency(parseNumericInput(prefix + 'title-fees')),
                    includeFees: document.getElementById(prefix + 'include-fees').checked ? 'Yes' : 'No'
                };
                const results = {
                     primaryResultLabel: document.getElementById('primary-result-label').textContent,
                     primaryResultValue: document.getElementById('primary-result-value').textContent,
                     affordablePrice: document.getElementById('affordable-price-result').textContent, 
                     totalLoan: document.getElementById('total-loan').textContent,
                     saleTax: document.getElementById('sale-tax').textContent,
                     totalFees: document.getElementById('total-fees').textContent, 
                     upfrontPayment: document.getElementById('upfront-payment').textContent,
                     totalPaymentsLabel: document.getElementById('loan-payments-text').textContent,
                     totalPaymentsValue: document.getElementById('loan-payments').textContent,
                     totalInterest: document.getElementById('loan-interest').textContent,
                     totalCost: document.getElementById('total-cost').textContent
                };

                let yPos = 15; const xMargin = 15; const valueOffset = 65; 
                const lineSpacing = 7; const sectionSpacing = 10;
                doc.setFontSize(16); doc.text("Auto Loan Calculation Summary", doc.internal.pageSize.getWidth() / 2, yPos, { align: 'center' });
                yPos += sectionSpacing * 1.5; doc.setFontSize(12); doc.text(`Calculation Mode: ${inputs.mode}`, xMargin, yPos);
                yPos += lineSpacing * 1.5; doc.setFontSize(11); doc.setFont(undefined, 'bold'); doc.text("Input Parameters:", xMargin, yPos);
                yPos += lineSpacing; doc.setFont(undefined, 'normal'); 
                const addInputLine = (label, value) => { doc.text(`${label}:`, xMargin + 5, yPos); doc.text(String(value), xMargin + valueOffset, yPos); yPos += lineSpacing; };
                addInputLine(inputs.autoPriceOrMonthlyPayLabel, inputs.autoPriceOrMonthlyPayValue); addInputLine("Loan Term (Months)", inputs.loanTerm); addInputLine("Interest Rate (%)", inputs.interestRate.toFixed(2)); addInputLine("Cash Incentives", inputs.cashIncentives); addInputLine("Down Payment", inputs.downPayment); addInputLine("Trade-in Value", inputs.tradeInValue); addInputLine("Amount Owed on Trade", inputs.amountOwed); addInputLine("State", inputs.state); addInputLine("Sales Tax Rate (%)", inputs.salesTaxRate.toFixed(2)); addInputLine("Title, Reg & Fees", inputs.titleFees); addInputLine("Include Taxes/Fees in Loan", inputs.includeFees);
                yPos += sectionSpacing - lineSpacing; doc.setFontSize(11); doc.setFont(undefined, 'bold'); doc.text("Calculated Results:", xMargin, yPos);
                yPos += lineSpacing; doc.setFont(undefined, 'normal');
                 const addResultLine = (label, value) => { doc.text(`${label}:`, xMargin + 5, yPos); doc.text(String(value), xMargin + valueOffset, yPos); yPos += lineSpacing; };
                 addResultLine(results.primaryResultLabel.replace(':',''), results.primaryResultValue);
                 if (currentCalcMode === 'monthly-payment') { addResultLine("Affordable Auto Price", results.affordablePrice); }
                addResultLine("Total Loan Amount", results.totalLoan); addResultLine("Sale Tax Amount", results.saleTax); addResultLine("Total Fees (Title/Reg)", results.totalFees); addResultLine("Upfront Payment", results.upfrontPayment); addResultLine(results.totalPaymentsLabel, results.totalPaymentsValue); addResultLine("Total Loan Interest", results.totalInterest); addResultLine("Total Cost", results.totalCost);
                doc.save('auto-loan-summary.pdf'); showMessageBox("PDF summary generated!");
            } catch (error) { console.error("Error generating PDF:", error); showMessageBox("Could not generate PDF. See console for details."); }
        }

        // --- Initialization ---
        window.onload = function() {
            console.log("Calculator initializing...");
            const currencyInputs = document.querySelectorAll('.input-field.currency');
            currencyInputs.forEach(input => setupCurrencyInputFormatting(input.id));
            const inputs = document.querySelectorAll('.input-field, input[type="checkbox"]');
             inputs.forEach(input => {
                 if (input.type === 'number' || input.type === 'text') { input.addEventListener('input', calculateLoan); }
                 if (input.tagName === 'SELECT' || input.type === 'checkbox') { input.addEventListener('change', calculateLoan); }
                 if (input.type === 'text') { input.addEventListener('blur', calculateLoan); }
             });
            // Initialize the view and perform first calculation
            switchTab(currentCalcMode, document.querySelector('.tab.active')); 
            console.log("Initialization complete.");
        };

    </script>
</body>
</html>
