<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Tic Tac Toe Content</title>
<style>
    * { box-sizing: border-box; }
    body {
        margin: 0;
        font-family: Tahoma, sans-serif;
        background-color: #ece9d8; /* Match XP window background */
        display: flex;
        flex-direction: column;
        align-items: center;       /* Center content horizontally */
        justify-content: center;   /* Center content vertically */
        height: 100%;              /* Full iframe height */
        overflow: hidden;          /* Prevent body scrollbars */
    }
    .game-container { /* New wrapper for game elements */
        padding: 10px;
        /* Optional: Add a border or different background if desired */
        /* background-color: #f8f8f8; */
        /* border: 1px solid #ccc; */
        /* border-radius: 5px; */
    }
    .game-controls {
        padding: 10px 0; /* More vertical padding */
        text-align: center;
    }
    .game-controls button {
        font-size: 13px; /* Slightly larger button text */
        padding: 5px 12px;
        font-family: Tahoma, sans-serif;
        border: 1px outset #ccc;
        background-color: #d4d0c8;
    }
    .game-status {
        font-weight: bold;
        margin-top: 10px; /* More space above status */
        min-height: 1.2em;
        font-size: 15px; /* Slightly larger status text */
        color: #333;
    }
    #tic-tac-toe-board {
        display: grid;
        grid-template-columns: repeat(3, 80px);
        grid-template-rows: repeat(3, 80px);
        gap: 6px; /* Slightly increased gap */
        background-color: #2c2c2c; /* Darker grid lines */
        border: 6px solid #2c2c2c; /* Match gap color for solid look */
        margin-top: 10px;
    }
    .ttt-cell {
        background-color: #fff;
        font-size: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-weight: bold;
        font-family: 'Arial Black', Gadget, sans-serif;
    }
     .ttt-cell:hover { background-color: #f0f0f0; }
     .ttt-cell.X { color: #0000CD; } /* MediumBlue */
     .ttt-cell.O { color: #DC143C; } /* Crimson */
</style>
</head>
<body>
    <div class="game-container">
        <div class="game-controls">
            <button id="ttt-new-game">New Game</button>
            <div id="ttt-status" class="game-status">Your turn (X)</div>
        </div>
        <div id="tic-tac-toe-board">
            <!-- Cells generated by JS -->
        </div>
    </div>

    <script>
        const boardDiv = document.getElementById('tic-tac-toe-board');
        const statusDiv = document.getElementById('ttt-status');
        const newGameButton = document.getElementById('ttt-new-game');
        let board = ['', '', '', '', '', '', '', '', ''];
        let currentPlayer = 'X';
        let gameOver = false;
        let aiMoveTimeout = null; // To store timeout ID for AI move

        function createBoard() {
            console.log("[TicTacToe] createBoard called.");
            cleanupGame(); // Clear any pending AI move if new game is clicked early

            boardDiv.innerHTML = '';
            board = ['', '', '', '', '', '', '', '', ''];
            currentPlayer = 'X';
            gameOver = false;
            statusDiv.textContent = "Your turn (X)";
            for (let i = 0; i < 9; i++) {
                const cell = document.createElement('div');
                cell.classList.add('ttt-cell');
                cell.dataset.index = i;
                cell.addEventListener('click', handleCellClick);
                boardDiv.appendChild(cell);
            }
        }

        function handleCellClick(event) {
            if (gameOver || currentPlayer !== 'X') return;
            const index = parseInt(event.target.dataset.index);
            if (board[index] === '') {
                makeMove(index, 'X');
                if (!gameOver) {
                    currentPlayer = 'O';
                    statusDiv.textContent = "AI's turn (O)";
                    // Clear any existing timeout before setting a new one
                    if (aiMoveTimeout) clearTimeout(aiMoveTimeout);
                    aiMoveTimeout = setTimeout(aiMove, 600); // AI moves after a short delay
                }
            }
        }

        function makeMove(index, player) {
            if (gameOver || board[index] !== '') return;
            board[index] = player;
            const cell = boardDiv.children[index];
            cell.textContent = player;
            cell.classList.add(player);

            if (checkWin(player)) {
                gameOver = true;
                statusDiv.textContent = `${player} wins!`;
                if (aiMoveTimeout) clearTimeout(aiMoveTimeout); // Stop AI if game ends
                return;
            }
            if (board.every(cellValue => cellValue !== '')) {
                gameOver = true;
                statusDiv.textContent = "It's a draw!";
                if (aiMoveTimeout) clearTimeout(aiMoveTimeout); // Stop AI if game ends
                return;
            }
        }

        function checkWin(player) {
            const winPatterns = [
                [0, 1, 2], [3, 4, 5], [6, 7, 8],
                [0, 3, 6], [1, 4, 7], [2, 5, 8],
                [0, 4, 8], [2, 4, 6]
            ];
            return winPatterns.some(pattern =>
                pattern.every(index => board[index] === player)
            );
        }

        function aiMove() {
            if (gameOver) return; // Should not happen if timeout cleared, but good check
            let availableCells = [];
            board.forEach((cell, index) => {
                if (cell === '') availableCells.push(index);
            });
            if (availableCells.length > 0) {
                const randomIndex = availableCells[Math.floor(Math.random() * availableCells.length)];
                makeMove(randomIndex, 'O');
                if (!gameOver) {
                    currentPlayer = 'X';
                    statusDiv.textContent = "Your turn (X)";
                }
            }
            aiMoveTimeout = null; // Clear timeout ID after execution
        }

        // --- Cleanup Function ---
        function cleanupGame() {
            console.log(`[TicTacToe] cleanupGame called. AI Timeout ID: ${aiMoveTimeout}`);
            if (aiMoveTimeout) {
                clearTimeout(aiMoveTimeout);
                aiMoveTimeout = null;
                console.log("[TicTacToe] AI move timeout cleared by cleanupGame.");
            }
            gameOver = true; // Ensure game state reflects it's over
        }

        // --- Event listener for messages from parent (for cleanup) ---
        window.addEventListener('message', (event) => {
            console.log(`[TicTacToe] Message received from parent. Data: "${event.data}", Origin: "${event.origin}"`);
            if (event.data === 'cleanup') {
                cleanupGame();
            }
        });

        // --- Initialization ---
        newGameButton.addEventListener('click', createBoard);
        createBoard(); // Start game on load
        window.focus();
    </script>
</body>
</html>
