<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Tic Tac Toe Content</title>
<style>
    * { box-sizing: border-box; }
    body {
        margin: 0;
        font-family: Tahoma, sans-serif;
        background-color: #ece9d8; /* Match XP window background */
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center; /* Center game content vertically */
        height: 100%;
        overflow: hidden;
        padding: 10px; /* Add some padding around the game area */
    }
    .game-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        /* background-color: #f0f0f0; */ /* Optional background for the game area */
        /* padding: 20px; */
        /* border-radius: 5px; */
    }
    .game-controls {
        padding-bottom: 15px; /* Increased space */
        text-align: center;
    }
    .game-controls button {
        font-size: 14px; /* Slightly larger */
        padding: 6px 15px; /* More padding */
        font-family: Tahoma, sans-serif;
        border: 1px outset #ccc;
        background-color: #d4d0c8;
    }
    .game-status {
        font-weight: bold;
        margin-top: 10px;
        min-height: 1.3em; /* Slightly taller */
        font-size: 18px; /* Larger status text */
        color: #333;
    }
    #tic-tac-toe-board {
        display: grid;
        /* Make cells larger: e.g., 100px or 110px depending on available space */
        /* Available height: ~496px (content) - ~70px (controls+status) - ~20px (margins) = ~400px */
        /* So 3 cells + 2 gaps could be around 120px per cell */
        /* Available width: ~430px. 3 cells + 2 gaps => ~130px per cell */
        /* Let's try 110px cells to be safe and look good */
        grid-template-columns: repeat(3, 110px);
        grid-template-rows: repeat(3, 110px);
        gap: 8px; /* Slightly larger gap */
        background-color: #2c2c2c;
        border: 8px solid #2c2c2c; /* Thicker border */
        margin-top: 15px;
    }
    .ttt-cell {
        background-color: #fff;
        font-size: 72px; /* Larger X/O symbols */
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-weight: bold;
        font-family: 'Arial Black', Gadget, sans-serif;
        border-radius: 3px; /* Slight rounding of cells */
    }
     .ttt-cell:hover { background-color: #f0f0f0; }
     .ttt-cell.X { color: #0000CD; } /* MediumBlue */
     .ttt-cell.O { color: #DC143C; } /* Crimson */
</style>
</head>
<body>
    <div class="game-container">
        <div class="game-controls">
            <button id="ttt-new-game">New Game</button>
            <div id="ttt-status" class="game-status">Your turn (X)</div>
        </div>
        <div id="tic-tac-toe-board">
            <!-- Cells generated by JS -->
        </div>
    </div>

    <script>
        const boardDiv = document.getElementById('tic-tac-toe-board');
        const statusDiv = document.getElementById('ttt-status');
        const newGameButton = document.getElementById('ttt-new-game');
        let board = ['', '', '', '', '', '', '', '', ''];
        let currentPlayer = 'X';
        let gameOver = false;
        let aiMoveTimeout = null;

        function createBoard() {
            console.log("[TicTacToe] createBoard called.");
            cleanupGame();

            boardDiv.innerHTML = '';
            board = ['', '', '', '', '', '', '', '', ''];
            currentPlayer = 'X';
            gameOver = false;
            statusDiv.textContent = "Your turn (X)";
            for (let i = 0; i < 9; i++) {
                const cell = document.createElement('div');
                cell.classList.add('ttt-cell');
                cell.dataset.index = i;
                cell.addEventListener('click', handleCellClick);
                boardDiv.appendChild(cell);
            }
        }

        function handleCellClick(event) {
            if (gameOver || currentPlayer !== 'X') return;
            const index = parseInt(event.target.dataset.index);
            if (board[index] === '') {
                makeMove(index, 'X');
                if (!gameOver) {
                    currentPlayer = 'O';
                    statusDiv.textContent = "AI's turn (O)";
                    if (aiMoveTimeout) clearTimeout(aiMoveTimeout);
                    aiMoveTimeout = setTimeout(aiMove, 600);
                }
            }
        }

        function makeMove(index, player) {
            if (gameOver || board[index] !== '') return;
            board[index] = player;
            const cell = boardDiv.children[index];
            cell.textContent = player;
            cell.classList.add(player);

            if (checkWin(player)) {
                gameOver = true;
                statusDiv.textContent = `${player} wins!`;
                if (aiMoveTimeout) clearTimeout(aiMoveTimeout);
                return;
            }
            if (board.every(cellValue => cellValue !== '')) {
                gameOver = true;
                statusDiv.textContent = "It's a draw!";
                if (aiMoveTimeout) clearTimeout(aiMoveTimeout);
                return;
            }
        }

        function checkWin(player) {
            const winPatterns = [
                [0, 1, 2], [3, 4, 5], [6, 7, 8],
                [0, 3, 6], [1, 4, 7], [2, 5, 8],
                [0, 4, 8], [2, 4, 6]
            ];
            return winPatterns.some(pattern =>
                pattern.every(index => board[index] === player)
            );
        }

        function aiMove() {
            if (gameOver) return;
            let availableCells = [];
            board.forEach((cell, index) => {
                if (cell === '') availableCells.push(index);
            });
            if (availableCells.length > 0) {
                const randomIndex = availableCells[Math.floor(Math.random() * availableCells.length)];
                makeMove(randomIndex, 'O');
                if (!gameOver) {
                    currentPlayer = 'X';
                    statusDiv.textContent = "Your turn (X)";
                }
            }
            aiMoveTimeout = null;
        }

        function cleanupGame() {
            console.log(`[TicTacToe] cleanupGame called. AI Timeout ID: ${aiMoveTimeout}`);
            if (aiMoveTimeout) {
                clearTimeout(aiMoveTimeout);
                aiMoveTimeout = null;
                console.log("[TicTacToe] AI move timeout cleared by cleanupGame.");
            }
            gameOver = true;
        }

        window.addEventListener('message', (event) => {
            console.log(`[TicTacToe] Message received from parent. Data: "${event.data}", Origin: "${event.origin}"`);
            if (event.data === 'cleanup') {
                cleanupGame();
            }
        });

        newGameButton.addEventListener('click', createBoard);
        createBoard();
        window.focus();
    </script>
</body>
</html>
