// Inside xp_desktop.html <script>

// ... (other functions like bringToFront, makeDraggable, etc. remain the same) ...

function createWindow(appId, title, url, width, height) {
    const windowId = `window-${appId}`;

    if (openWindows[windowId]) {
        const existingWindow = openWindows[windowId];
        existingWindow.style.display = 'block';
        bringToFront(existingWindow);
        const iframe = existingWindow.querySelector('iframe');
        if (iframe) {
            if (iframe.getAttribute('src') === 'about:blank' || iframe.getAttribute('src') !== url) {
                console.log(`Re-loading iframe for ${title} with src: ${url}`);
                iframe.setAttribute('src', url);
            } else {
                try {
                    console.log(`Attempting to focus existing iframe for ${title}`);
                    iframe.contentWindow?.focus();
                } catch (e) {
                    console.warn(`Focus failed on existing window for ${title}:`, e);
                }
            }
        }
        return;
    }

    const win = document.createElement('div');
    win.className = 'window';
    win.id = windowId;
    win.style.width = `${parseInt(width) || 400}px`;
    win.style.height = `${parseInt(height) || 300}px`;
    const initialLeft = 100 + (Object.keys(openWindows).length % 6) * 25;
    const initialTop = 50 + (Object.keys(openWindows).length % 6) * 25;
    win.style.left = `${initialLeft}px`;
    win.style.top = `${initialTop}px`;

    // The sandbox attribute is appropriate here because all framed content is trusted and part of the same application.
    // allow-same-origin is needed for the parent to script the child (e.g., call cleanupGame).
    win.innerHTML = `
        <div class="title-bar">
            <span class="title-bar-text">${title}</span>
            <div class="window-buttons">
                <button class="window-button close-button">X</button>
            </div>
        </div>
        <div class="window-content">
            <iframe src="about:blank" title="${title}" sandbox="allow-scripts allow-same-origin allow-pointer-lock allow-modals allow-forms"></iframe>
        </div>
    `;

    document.getElementById('desktop').appendChild(win);
    openWindows[windowId] = win;
    makeDraggable(win);

    const iframeElement = win.querySelector('iframe');
    // Set the src after appending to the DOM and ensuring the iframe element exists.
    // This can sometimes help with readyState and contentWindow availability.
    if (iframeElement) {
        console.log(`Setting initial iframe src for ${title} to: ${url}`);
        iframeElement.setAttribute('src', url);
    }


    const closeButton = win.querySelector('.close-button');
    closeButton.addEventListener('click', (e) => {
        e.stopPropagation();
        const iframe = win.querySelector('iframe');
        if (iframe) {
            console.log(`Close button clicked for ${title}. Current iframe src: ${iframe.getAttribute('src')}`);
            // Check if contentWindow is accessible AND if cleanupGame is a function
            if (iframe.contentWindow && typeof iframe.contentWindow.cleanupGame === 'function') {
                try {
                    console.log(`Attempting to call cleanupGame for ${title}`);
                    iframe.contentWindow.cleanupGame();
                    console.log(`CleanupGame function successfully called for ${title}`);
                } catch (err) {
                    // This is where your SecurityError would likely be caught if it's a direct access issue
                    console.error(`Error calling cleanupGame in ${title}:`, err.name, err.message);
                }
            } else {
                if (!iframe.contentWindow) {
                    console.warn(`iframe.contentWindow not accessible for ${title} during close.`);
                } else {
                    console.warn(`cleanupGame function not found or not a function in ${title}.`);
                }
            }
            // Regardless of cleanup success, always reset src to stop scripts
            console.log(`Setting iframe src to 'about:blank' for ${title}`);
            iframe.setAttribute('src', 'about:blank');
        } else {
            console.error(`Could not find iframe in window ${title} during close.`);
        }
        win.style.display = 'none';
    });

    bringToFront(win);
    setTimeout(() => {
        const iframe = win.querySelector('iframe');
        if (iframe) {
            try {
                console.log(`Attempting to focus iframe on creation for ${title}`);
                iframe.contentWindow?.focus();
            } catch (e) {
                console.warn(`Focus failed on iframe creation for ${title}:`, e);
            }
        }
    }, 250); // Slightly increased delay
}

// The rest of xp_desktop.html (icon listeners, clock, etc.) remains the same
// ...
