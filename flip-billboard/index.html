<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Flip Billboard â€” W Defaults + Jungle</title>
<link rel="stylesheet" href="./flip.min.css?v=16" />
<style>
:root{
  --billboard-size: 9em;   /* same as flip clock */
  --panel-radius: 0em;     /* square by default */
  --stage-shift: -10vh;    /* raise billboard */

  /* W-only tuning defaults */
  --w-scale: 0.86;
  --w-offset: -0.01em;

  color-scheme: light only;
}

html, body { height: 100%; margin: 0; }
body {
  min-height: 100svh;
  display: grid;
  grid-template-rows: auto 1fr;
  background: #fff;
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
}

/* Controls on top (clickable) */
.controls {
  position: sticky; top: 0; z-index: 1000;
  display: grid; grid-template-columns: 1fr auto;
  gap: 10px 18px; align-items: center;
  padding: 10px 12px; border-bottom: 1px solid #eee;
  background: #fafafa;
  font: 13px/1.35 ui-sans-serif, system-ui, -apple-system, Arial, sans-serif;
  color: #333;
}
.rows { display: grid; gap: 10px; }
.row  { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
.controls label { white-space: nowrap; }
.controls input[type="number"] { width: 6ch; }
.controls input[type="text"] { width: min(800px, 60vw); }
.actions { display: flex; gap: 8px; justify-content: flex-end; align-items: center; }
.controls small { opacity: .65; }

/* Stage below controls; ignore pointer events */
.stage {
  position: relative; z-index: 0; pointer-events: none;
  display: grid; place-items: center;
  padding: 2vh 3vw;
  transform: translateY(var(--stage-shift));
  transition: transform .25s ease;
}

.tick { font-size: 1rem; white-space: nowrap; font-family: arial, sans-serif; }
.tick-flip, .tick-text-inline { font-size: var(--billboard-size); }

.tick-char { width: 1.15em; }
.tick-group { margin: 0 .5em; text-align: center; }

.tick-text-inline {
  display: inline-block; text-align: center; min-width: 1em;
  color: rgb(90,93,99) !important;
}
.tick-text-inline + .tick-text-inline { margin-left: -.325em; }

.tick-label { margin-top: 1em; font-size: 1em; color: rgb(90,93,99) !important; }

.tick-flip-panel {
  color: #fff !important; background: rgb(59,61,59) !important;
  border-radius: var(--panel-radius) !important;
  box-shadow: 0 8px 30px rgba(0,0,0,.08);
}
.tick-flip-panel-text-wrapper { line-height: 1.45 !important; text-align: center; }

button {
  appearance: none; border: 1px solid #ddd; background: #fff;
  padding: 6px 10px; border-radius: 8px; cursor: pointer;
}
button:hover { background: #f4f4f4; }

/* Apply transform to W/w only (robust across flip states) */
.tick-flip-panel.has-wide-letter .tick-flip-panel-text,
.tick-flip-panel.has-wide-letter .tick-flip-panel-text-wrapper {
  display: inline-block !important;
  transform: translateX(var(--w-offset)) scaleX(var(--w-scale)) !important;
  transform-origin: center !important;
}
</style>
</head>
<body>

<form class="controls" id="controls" onsubmit="return false;">
  <div class="rows">
    <div class="row">
      <label>Size (em):
        <input id="sizeEm" type="number" step="0.1" min="2" max="20" value="9">
      </label>
      <input id="sizeRange" type="range" step="0.1" min="2" max="20" value="9" />

      <label>Corner radius (em):
        <input id="radiusEm" type="number" step="0.01" min="0" max="0.6" value="0">
      </label>
      <input id="radiusRange" type="range" step="0.01" min="0" max="0.6" value="0" />

      <label>Position (vh):
        <input id="posVh" type="number" step="1" min="-60" max="60" value="-10">
      </label>
      <input id="posRange" type="range" step="1" min="-60" max="60" value="-10" />

      <label>Speed (ms):
        <input id="speedMs" type="number" step="100" min="300" max="20000" value="3000">
      </label>

      <label>W scaleX:
        <input id="wScale" type="number" step="0.01" min="0.80" max="1.00" value="0.86">
      </label>
      <label>W offset (em):
        <input id="wOffset" type="number" step="0.01" min="-0.10" max="0.10" value="-0.01">
      </label>
    </div>

    <div class="row">
      <label for="words">Words (comma-separated):</label>
      <input id="words" type="text"
             placeholder="WELCOME, TO, THE, JUNGLE, BABY!" />
      <small>(We pad to keep widths steady.)</small>
    </div>
  </div>

  <div class="actions">
    <button id="applyWords">Apply</button>
    <button id="reset">Reset</button>
  </div>
</form>

<div class="stage">
  <div class="tick" data-did-init="handleTickInit">
    <div data-repeat="true" data-layout="horizontal fit"
         data-transform="upper -> split -> delay(random, 120, 180)">
      <span data-view="flip"
            data-transform="ascii -> arrive -> round -> char(a-zA-Z)"
            class="tick-char"></span>
    </div>
  </div>
</div>

<script src="./flip.min.js?v=16"></script>
<script>
// ---------- helpers ----------
const $ = (id) => document.getElementById(id);
const css = document.documentElement.style;
const LS_KEY = 'flip-billboard-settings-v16';

function padWords(words) {
  const clean = words.map(w => (w || '').toString().trim().toUpperCase());
  const max = clean.reduce((m, w) => Math.max(m, w.length), 0);
  return clean.map(w => w.padEnd(max, ' '));
}

function loadSettings() {
  try {
    const s = JSON.parse(localStorage.getItem(LS_KEY));
    if (s && Array.isArray(s.words)) return s;
  } catch {}
  return {
    // NEW defaults
    words: ['WELCOME','TO','THE','JUNGLE','BABY!'],
    sizeEm: 9, radiusEm: 0, posVh: -10, speedMs: 3000,
    wScale: 0.86, wOffset: -0.01
  };
}
function saveSettings(obj) { localStorage.setItem(LS_KEY, JSON.stringify(obj)); }

function applyUI(s) {
  $('sizeEm').value = s.sizeEm; $('sizeRange').value = s.sizeEm;
  $('radiusEm').value = s.radiusEm; $('radiusRange').value = s.radiusEm;
  $('posVh').value = s.posVh; $('posRange').value = s.posVh;
  $('speedMs').value = s.speedMs;
  $('wScale').value = s.wScale;
  $('wOffset').value = s.wOffset;
  $('words').value = s.words.join(', ');
  css.setProperty('--billboard-size', s.sizeEm + 'em');
  css.setProperty('--panel-radius', s.radiusEm + 'em');
  css.setProperty('--stage-shift', s.posVh + 'vh');
  css.setProperty('--w-scale', s.wScale);
  css.setProperty('--w-offset', s.wOffset + 'em');
}

// Tag panels that currently display W/w so transforms apply reliably
function remarkWidePanels() {
  document.querySelectorAll('.tick-flip-panel').forEach(panel => {
    const el = panel.querySelector('.tick-flip-panel-text, .tick-flip-panel-text-wrapper');
    const ch = (el?.textContent || '').trim();
    panel.classList.toggle('has-wide-letter', ch === 'W' || ch === 'w');
  });
}

const billboardObserver = new MutationObserver(() => {
  requestAnimationFrame(remarkWidePanels);
});

// ---------- billboard state ----------
let ROTATION = [];
let tickRef = null;
let timerCancel = null;

function setRotation(words) {
  ROTATION = padWords(words);
  if (tickRef) tickRef.value = ROTATION[0] || '';
  requestAnimationFrame(remarkWidePanels);
}

function startTicker(speed) {
  if (timerCancel) { timerCancel(); timerCancel = null; }
  let i = 0;
  timerCancel = Tick.helper.interval(function () {
    if (!ROTATION.length) return;
    i = (i + 1) % ROTATION.length;
    tickRef.value = ROTATION[i];
    remarkWidePanels();
  }, speed);
}

function handleTickInit(tick) {
  tickRef = tick;
  tick.value = ROTATION[0] || '';
  const root = document.querySelector('.tick');
  if (root) {
    billboardObserver.observe(root, { childList: true, subtree: true, characterData: true });
  }
  startTicker(current.speedMs);
  remarkWidePanels();
}
window.handleTickInit = handleTickInit;

// ---------- init ----------
const current = loadSettings();

(function init(){
  setRotation(current.words);
  applyUI(current);

  // live controls
  $('sizeEm').addEventListener('input', e => {
    const v = +e.target.value; $('sizeRange').value = v;
    css.setProperty('--billboard-size', v + 'em'); current.sizeEm = v; saveSettings(current); remarkWidePanels();
  });
  $('sizeRange').addEventListener('input', e => {
    const v = +e.target.value; $('sizeEm').value = v;
    css.setProperty('--billboard-size', v + 'em'); current.sizeEm = v; saveSettings(current); remarkWidePanels();
  });

  $('radiusEm').addEventListener('input', e => {
    const v = +e.target.value; $('radiusRange').value = v;
    css.setProperty('--panel-radius', v + 'em'); current.radiusEm = v; saveSettings(current);
  });
  $('radiusRange').addEventListener('input', e => {
    const v = +e.target.value; $('radiusEm').value = v;
    css.setProperty('--panel-radius', v + 'em'); current.radiusEm = v; saveSettings(current);
  });

  $('posVh').addEventListener('input', e => {
    const v = +e.target.value; $('posRange').value = v;
    css.setProperty('--stage-shift', v + 'vh'); current.posVh = v; saveSettings(current);
  });
  $('posRange').addEventListener('input', e => {
    const v = +e.target.value; $('posVh').value = v;
    css.setProperty('--stage-shift', v + 'vh'); current.posVh = v; saveSettings(current);
  });

  $('speedMs').addEventListener('input', e => {
    const v = Math.max(300, +e.target.value || 3000);
    current.speedMs = v; saveSettings(current);
    if (tickRef) startTicker(current.speedMs);
  });

  $('wScale').addEventListener('input', e => {
    const v = Math.min(1.00, Math.max(0.80, +e.target.value || 0.86));
    current.wScale = v; css.setProperty('--w-scale', v);
    saveSettings(current); remarkWidePanels();
  });
  $('wOffset').addEventListener('input', e => {
    const v = Math.min(0.10, Math.max(-0.10, +e.target.value || -0.01));
    current.wOffset = v; css.setProperty('--w-offset', v + 'em');
    saveSettings(current); remarkWidePanels();
  });

  $('applyWords').addEventListener('click', () => {
    const raw = $('words').value.split(',').map(s => s.trim()).filter(Boolean);
    if (!raw.length) return;
    current.words = raw; saveSettings(current); setRotation(current.words);
  });

  $('reset').addEventListener('click', () => {
    localStorage.removeItem(LS_KEY);
    location.href = location.pathname;
  });
})();
</script>
</body>
</html>
