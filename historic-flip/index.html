<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Historic Flip — Preset Count‑Up</title>

  <!-- Flip (Tick) styles -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@pqina/flip/dist/flip.min.css" />

  <style>
    :root{
      --bg:#ffffff;
      --text:#0b3b17;        /* title + labels */
      --value:#5b2a77;       /* digits color */
      --panel-bg:#ba7630;    /* flip panel background */
      --radius:12px;         /* card corner radius */
      --leading:1.4;         /* line-height inside panel */
    }

    * { box-sizing: border-box; }
    html, body { height:100%; }

    body {
      margin:0;
      background:var(--bg);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      color:#0f172a;
      display:grid;
      grid-template-rows:auto 1fr auto auto; /* header, CLOCK, bars, footer */
      gap:.25rem;
      transition:background .15s ease;
    }

    /* Light header; keep focus on clock */
    header{
      padding:.6rem clamp(1rem, 3vw, 2rem) 0;
    }
    header h1{
      margin:0;
      font-size:clamp(1rem, 1.2vw, 1.1rem);
      font-weight:600;
      color:#334155;
      letter-spacing:.2px;
      opacity:.75;
    }

    /* ===== CLOCK FIRST ===== */
    .stage{
      display:grid;
      place-items:center;
      padding: .25rem clamp(.5rem, 3vw, 2rem) .25rem; /* tighter than before */
    }
    .title{
      text-align:center;
      font-size:clamp(1.2rem, 2.8vw, 1.7rem);
      margin:.1rem 0 .25rem;
      color:var(--text);
      min-height:1.6em;
    }

    .tick { font-size:1rem; white-space:nowrap; }
    .tick-flip, .tick-text-inline { font-size:7em; } /* your 7em */
    .tick-group { margin:0 .35em; text-align:center; }
    .tick-label { margin-top:.7em; font-size:1em; color:var(--text) !important; }

    .tick-flip { border-radius:var(--radius) !important; }
    .tick-flip-panel { background-color:var(--panel-bg) !important; color:var(--value) !important; }
    .tick-flip-panel-text-wrapper { line-height:var(--leading) !important; }
    .tick-credits{ display:none !important; } /* remove PQINA credit */

    /* ===== Compact bars under the clock ===== */
    .bar{
      max-width:1200px;
      margin:0 auto;
      width:100%;
      padding:0 clamp(1rem, 3vw, 2rem) .35rem;
    }

    .eventbar, .presetbar{
      display:flex;
      gap:.5rem;
      align-items:center;
      border:1px solid #e5e7eb;
      border-radius:14px;
      padding:.5rem;
      background:#fff;
      box-shadow:0 1px 2px rgba(0,0,0,.04);
      margin-bottom:.35rem;
    }

    .eventbar input[type="text"],
    .eventbar input[type="datetime-local"],
    .presetbar select{
      border:1px solid #dfe3e6;
      border-radius:10px;
      padding:.5rem .6rem;
      font-size:.95rem;
      min-width:0;
      background:#fff;
    }
    .eventbar .grow{ flex:1 1 420px; }
    .eventbar .when{ flex:0 0 220px; }

    .presetbar .grow{ flex:1 1 420px; }

    .btn{
      appearance:none; border:0; cursor:pointer;
      border-radius:10px; font-weight:600; font-size:.95rem;
      padding:.55rem .9rem;
    }
    .btn.primary{ background:#0f766e; color:#fff; }
    .btn.ghost{ background:#f1f5f9; color:#0f172a; }
    .btn.danger{ background:#ef4444; color:#fff; }

    /* Collapsible style panel (optional) */
    details.panel{
      max-width:1200px;
      margin:.1rem auto 0;
      padding:0 clamp(1rem, 3vw, 2rem);
    }
    details.panel > summary{
      list-style:none;
      cursor:pointer;
      user-select:none;
      font-weight:600;
      color:#334155;
      background:#ffffff;
      border:1px solid #e5e7eb;
      border-radius:12px;
      padding:.6rem .9rem;
      box-shadow:0 1px 2px rgba(0,0,0,.04);
    }
    details.panel[open] > summary{ border-bottom-left-radius:0; border-bottom-right-radius:0; }
    .panel-body{
      border:1px solid #e5e7eb;
      border-top:0;
      border-bottom-left-radius:12px;
      border-bottom-right-radius:12px;
      background:#fff;
      padding:.8rem;
      display:flex; flex-wrap:wrap; gap:.75rem 1rem;
    }
    .chip{
      display:flex; align-items:center; gap:.5rem;
      border:1px solid #d1d5db;
      border-radius:999px;
      padding:.25rem .6rem;
      background:#fff;
    }
    .chip label{ font-size:.9rem; color:#111827; }
    .chip input[type="color"]{ width:36px; height:28px; border:1px solid #cbd5e1; border-radius:8px; padding:0; }
    .chip select, .chip input[type="range"]{
      border:1px solid #cbd5e1; border-radius:8px; padding:.3rem .45rem; font-size:.9rem; background:#fff;
    }
    .chip input[type="range"]{ width:140px; }

    footer{
      text-align:center; color:#94a3b8; font-size:.85rem; padding:.25rem 0 1rem;
    }
  </style>
</head>
<body>
  <header><h1>Historic Flip — Preset Count‑Up</h1></header>

  <!-- CLOCK FIRST -->
  <section class="stage">
    <div class="title" id="titleLine"></div>

    <div class="tick" id="tickRoot" data-did-init="handleTickInit">
      <div data-repeat="true" data-layout="horizontal fit" data-transform="preset(y, M, d, h, m, s) -> delay">
        <div class="tick-group">
          <div data-key="value" data-repeat="true" data-transform="pad(00) -> split -> delay">
            <span data-view="flip"></span>
          </div>
          <span data-key="label" data-view="text" class="tick-label"></span>
        </div>
      </div>
    </div>
  </section>

  <!-- Presets bar -->
  <div class="bar">
    <div class="presetbar">
      <select id="presetSelect" class="grow" title="Choose a historical event to load">
        <!-- Populated by JS -->
      </select>
      <button id="btnLoadPreset" class="btn ghost" title="Load selected preset into the event fields">Load preset</button>
      <button id="btnStartPreset" class="btn primary" title="Load and start">Load & Start</button>
    </div>

    <!-- Compact Event Bar -->
    <div class="eventbar">
      <input id="eventName" class="grow" type="text" placeholder="Event name (e.g., Y2K — New Millennium)" />
      <input id="eventStart" class="when" type="datetime-local" />
      <button id="btnStart" class="btn primary">Start</button>
      <button id="btnSave" class="btn ghost">Save default</button>
      <button id="btnClear" class="btn danger">Clear</button>
    </div>
  </div>

  <!-- Optional Style Panel (collapsed by default) -->
  <details class="panel">
    <summary>Style</summary>
    <div class="panel-body">
      <div class="chip"><label>Background</label><input id="bgColor" type="color" value="#ffffff"></div>
      <div class="chip"><label>Text</label><input id="textColor" type="color" value="#0b3b17"></div>
      <div class="chip"><label>Value</label><input id="valueColor" type="color" value="#5b2a77"></div>
      <div class="chip">
        <label>Font</label>
        <select id="fontFamily">
          <option value="system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif">System UI</option>
          <option value="Arial, Helvetica, sans-serif">Arial</option>
          <option value="Georgia, serif">Georgia</option>
          <option value="'Courier New', monospace">Courier New</option>
          <option value="'Trebuchet MS', Arial, sans-serif">Trebuchet MS</option>
        </select>
      </div>
      <div class="chip"><label>Leading</label><input id="leading" type="range" min="1.0" max="2.0" step="0.05" value="1.4"></div>
      <div class="chip"><label>Panel</label><input id="panelBg" type="color" value="#ba7630"></div>
      <div class="chip">
        <label>Corner</label>
        <select id="cornerStyle">
          <option value="square">Square</option>
          <option value="soft" selected>Soft</option>
          <option value="round">Rounded</option>
          <option value="xround">Extra‑round</option>
        </select>
      </div>
      <div class="chip"><label>Radius</label><input id="cornerRadius" type="range" min="0" max="32" step="1" value="12"></div>
    </div>
  </details>

  <footer>Counting up from your chosen moment • Works offline on GitHub Pages</footer>

  <!-- Flip (Tick) script -->
  <script src="https://cdn.jsdelivr.net/npm/@pqina/flip/dist/flip.min.js"></script>

  <script>
    /* ========= Presets =========
       Times are best-effort/commonly cited; edit as needed.
       Use timezone offsets (e.g., Z, -04:00, +01:00) if you want fixed reference.
    */
    const HISTORICAL_PRESETS = [
      { name: 'Apollo 11 — Moon Landing (LM touchdown)', at: '1969-07-20T20:17:40Z' },
      { name: 'Apollo 11 — First step on the Moon',       at: '1969-07-21T02:56:15Z' },
      { name: 'Fall of the Berlin Wall',                   at: '1989-11-09T22:30:00+01:00' },
      { name: 'World Wide Web publicly available',         at: '1991-08-06T00:00:00Z' },
      { name: 'USSR dissolution (Gorbachev resignation)',  at: '1991-12-25T19:32:00Z' },
      { name: '9/11 — First impact (AA11)',                at: '2001-09-11T08:46:30-04:00' },
      { name: 'Wright Brothers — First flight',            at: '1903-12-17T10:35:00-05:00' },
      { name: 'MLK Jr. — "I Have a Dream" speech',         at: '1963-08-28T15:00:00-04:00' },
      { name: 'Mount Everest First Summit',                at: '1953-05-29T11:30:00+05:45' },
      { name: 'Rosa Parks — Montgomery bus arrest',        at: '1955-12-01T18:00:00-06:00' },
      { name: 'VE Day in Europe',                           at: '1945-05-08T00:00:00Z' },
      { name: 'Y2K — New Millennium',                      at: '2000-01-01T00:00:00' }
    ];

    /* ========== Helpers ========== */
    const qs = id => document.getElementById(id);
    const LS_EVENT = 'historicFlipEvent';
    const LS_STYLE = 'historicFlipStyle';

    function isoLocalFromInput(v){ return v ? (v.length === 16 ? v + ':00' : v) : null; }
    function setTitle(t){ qs('titleLine').textContent = t || ''; }
    function parseQuery(){ const p = new URLSearchParams(location.search); return {event:p.get('event')||'', at:p.get('at')||''}; }

    /* ========== Tick lifecycle (prevents multi‑flip) ========== */
    let tickInstance = null;
    let counter = null;
    let restartTimer = null;

    function safeStopCounter(){
      if (counter){
        try { counter.onupdate = null; counter.stop(); } catch(e){}
        counter = null;
      }
    }
    function startCounter(isoLocal){
      safeStopCounter();
      counter = Tick.count.up(isoLocal, { format: ['y','M','d','h','m','s'] });
      counter.onupdate = (value) => { if (tickInstance) tickInstance.value = value; };
    }

    function handleTickInit(tick){
      tickInstance = tick;

      const locale = {
        YEAR_PLURAL:'Years', YEAR_SINGULAR:'Year',
        MONTH_PLURAL:'Months', MONTH_SINGULAR:'Month',
        WEEK_PLURAL:'Weeks', WEEK_SINGULAR:'Week',
        DAY_PLURAL:'Days', DAY_SINGULAR:'Day',
        HOUR_PLURAL:'Hours', HOUR_SINGULAR:'Hour',
        MINUTE_PLURAL:'Minutes', MINUTE_SINGULAR:'Minute',
        SECOND_PLURAL:'Seconds', SECOND_SINGULAR:'Second',
        MILLISECOND_PLURAL:'Milliseconds', MILLISECOND_SINGULAR:'Millisecond'
      };
      for (const k in locale) tick.setConstant(k, locale[k]);

      populatePresets();
      bootEvent();
      bootStyle();
    }

    /* ========== Presets UI ========== */
    function populatePresets(){
      const sel = qs('presetSelect');
      sel.innerHTML = '';
      HISTORICAL_PRESETS.forEach((p, idx) => {
        const opt = document.createElement('option');
        opt.value = String(idx);
        opt.textContent = p.name + ' — ' + p.at;
        sel.appendChild(opt);
      });
    }
    function applyPresetToFields(index){
      const p = HISTORICAL_PRESETS[Number(index)];
      if (!p) return;
      qs('eventName').value = p.name;
      // Put ISO into datetime-local if no timezone offset; otherwise leave as-is on Start
      if (/([+-]\d{2}:\d{2}|Z)$/.test(p.at)) {
        // show local-friendly value but we will use the ISO with TZ when starting
        qs('eventStart').value = p.at.slice(0,16); // visual hint only
        qs('eventStart').dataset.tziso = p.at;     // store full ISO with TZ
      } else {
        qs('eventStart').value = p.at.slice(0,16);
        qs('eventStart').dataset.tziso = '';
      }
    }
    qs('btnLoadPreset').addEventListener('click', () => {
      applyPresetToFields(qs('presetSelect').value);
    });
    qs('btnStartPreset').addEventListener('click', () => {
      applyPresetToFields(qs('presetSelect').value);
      applyEventFromUI(/*preferPresetTZ*/true);
    });

    /* ========== Event state ========== */
    function bootEvent(){
      const q = parseQuery();
      let name, iso;
      if (q.at){
        name = q.event || 'Historic Event';
        iso = q.at;
      } else {
        const saved = JSON.parse(localStorage.getItem(LS_EVENT) || 'null');
        if (saved?.name && saved?.isoLocal){ name = saved.name; iso = saved.isoLocal; }
        else { name = 'Y2K — New Millennium'; iso = '2000-01-01T00:00:00'; }
      }
      setTitle(name);
      startCounter(iso);
      qs('eventName').value = name;
      qs('eventStart').value = (iso || '').slice(0,16);
    }

    function applyEventFromUI(preferPresetTZ=false){
      const name = (qs('eventName').value || 'Historic Event').trim();

      // If the preset stored a timezone-specific ISO, prefer it on start
      let tzIso = qs('eventStart').dataset.tziso || '';
      let iso = preferPresetTZ && tzIso ? tzIso : (isoLocalFromInput(qs('eventStart').value) || '2000-01-01T00:00:00');

      setTitle(name);

      if (restartTimer) clearTimeout(restartTimer);
      restartTimer = setTimeout(() => { startCounter(iso); }, 100);

      const url = new URL(location.href);
      url.searchParams.set('event', name);
      url.searchParams.set('at', iso);
      history.replaceState({}, '', url);
    }

    qs('btnStart').addEventListener('click', () => applyEventFromUI(false));

    qs('btnSave').addEventListener('click', () => {
      const name = (qs('eventName').value || 'Historic Event').trim();
      // If there is a timezone ISO from preset, save that; else save local input
      const tzIso = qs('eventStart').dataset.tziso || '';
      const iso = tzIso || isoLocalFromInput(qs('eventStart').value) || '2000-01-01T00:00:00';
      localStorage.setItem(LS_EVENT, JSON.stringify({name, isoLocal: iso}));
      qs('btnSave').textContent = 'Saved ✓';
      setTimeout(() => qs('btnSave').textContent = 'Save default', 1000);
    });

    qs('btnClear').addEventListener('click', () => {
      localStorage.removeItem(LS_EVENT);
      qs('btnClear').textContent = 'Cleared ✓';
      setTimeout(() => qs('btnClear').textContent = 'Clear', 1000);
    });

    /* ========== Style state ========== */
    const styleEls = {
      bg: qs('bgColor'),
      text: qs('textColor'),
      value: qs('valueColor'),
      font: qs('fontFamily'),
      leading: qs('leading'),
      panelBg: qs('panelBg'),
      cornerStyle: qs('cornerStyle'),
      cornerRadius: qs('cornerRadius')
    };
    function applyStyle(s){
      if (s.bg)      document.documentElement.style.setProperty('--bg', s.bg);
      if (s.text)    document.documentElement.style.setProperty('--text', s.text);
      if (s.value)   document.documentElement.style.setProperty('--value', s.value);
      if (s.panelBg) document.documentElement.style.setProperty('--panel-bg', s.panelBg);
      if (s.leading) document.documentElement.style.setProperty('--leading', s.leading);
      if (s.font)    document.body.style.fontFamily = s.font;

      const preset = { square:0, soft:12, round:18, xround:26 };
      let r = s.cornerRadius != null ? Number(s.cornerRadius) : preset.soft;
      if (s.cornerStyle && s.cornerRadius == null) r = preset[s.cornerStyle] ?? r;
      document.documentElement.style.setProperty('--radius', r + 'px');
    }
    function styleFromUI(){
      return {
        bg:styleEls.bg.value, text:styleEls.text.value, value:styleEls.value.value,
        font:styleEls.font.value, leading:styleEls.leading.value, panelBg:styleEls.panelBg.value,
        cornerStyle:styleEls.cornerStyle.value, cornerRadius:styleEls.cornerRadius.value
      };
    }
    function setUIFromStyle(s){
      if (s.bg) styleEls.bg.value = s.bg;
      if (s.text) styleEls.text.value = s.text;
      if (s.value) styleEls.value.value = s.value;
      if (s.font) styleEls.font.value = s.font;
      if (s.leading) styleEls.leading.value = s.leading;
      if (s.panelBg) styleEls.panelBg.value = s.panelBg;
      if (s.cornerStyle) styleEls.cornerStyle.value = s.cornerStyle;
      if (s.cornerRadius != null) styleEls.cornerRadius.value = s.cornerRadius;
    }
    function saveStyle(s){ localStorage.setItem(LS_STYLE, JSON.stringify(s)); }
    function bootStyle(){
      const saved = JSON.parse(localStorage.getItem(LS_STYLE) || 'null') || {
        bg:'#ffffff', text:'#0b3b17', value:'#5b2a77',
        font:"system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif",
        leading:'1.4', panelBg:'#ba7630', cornerStyle:'soft', cornerRadius:'12'
      };
      setUIFromStyle(saved);
      applyStyle(saved);
    }
    Object.values(styleEls).forEach(el => {
      el.addEventListener('input', () => { const s = styleFromUI(); if (el === styleEls.cornerStyle) s.cornerRadius = null; applyStyle(s); saveStyle(s); });
      el.addEventListener('change', () => { const s = styleFromUI(); applyStyle(s); saveStyle(s); });
    });
  </script>
</body>
</html>
